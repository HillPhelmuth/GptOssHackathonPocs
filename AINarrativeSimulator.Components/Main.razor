@namespace AINarrativeSimulator.Components

<div class="app-shell">
    <!-- Header -->
    <header class="site-header">
        <div class="container">
            <div class="header-row">
                <div class="brand">
                    <div class="brand-icon"></div>
                    <div>
                        <h1 class="brand-title">The Emergent Narrative Simulator</h1>
                        <p class="brand-subtitle">@WorldState.Name - @WorldState.Description</p>
                    </div>
                </div>
                <div class="header-right">
                    <div class="tech-badge">
                        <span class="spark"></span>
                        <span>Living World Technology</span>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" @onclick="OpenSummaryModal">Generate World Summary</button>
                        <button class="btn btn-secondary" @onclick="ToggleWorldPanel">@(_showWorldController ? "Hide World Controller" : "Show World Controller")</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container main-content">
        <div class="main-grid @( _showWorldController ? string.Empty : "no-right")" @ref="_grid">
            <!-- Left Column - Event Feed -->
            <div class="col">
                <button @onclick="@(() => _showComics = !_showComics)">@(_showComics ? "Events":"Comics")</button>
                @if (_showComics)
                {
                    <BeatTicker Beats="_beats"></BeatTicker>
                }
                else
                {
                    <EventFeed Actions="@_actions" />
                }
                @* <EventFeed Actions="@_actions"/> *@
            </div>
            <!-- Gutter between col 1 and 2 -->
            <div class="gutter" data-gutter="1" aria-hidden="true"></div>

            <!-- Middle Column - Agent Inspector -->
            <div class="col">
                <AgentInspector Agents="@_agents" SelectedAgentId="@selectedAgentId" SelectedAgentIdChanged="@OnSelectedAgentChanged" />
            </div>

            @if (_showWorldController)
            {
                <!-- Gutter between col 2 and 3 -->
                <div class="gutter" data-gutter="2" aria-hidden="true"></div>
                <!-- Right Column - World Controller -->
                <div class="col">
                    <WorldController IsRunning="@isRunning"
                                     OnStart="@HandleStart"
                                     OnStop="@HandleStop"
                                     OnReset="@HandleReset"
                                     InjectRumor="@HandleInjectRumor"
                                     InjectEvent="@HandleInjectEvent"
                                     WorldState="@WorldState" />
                </div>
            }
        </div>

        <!-- Description Panel -->
        <div class="desc-panel">
            <h2 class="desc-title">
                <span class="desc-icon"></span>
                About This Simulation
            </h2>
            <div class="desc-grid">
                <div>
                    <h3 class="desc-h3">Emergent Narratives</h3>
                    <p>Watch as @WorldState.WorldAgents.Agents.Count autonomous AI agents create their own stories through interactions, without any predetermined script. Each agent has unique personalities, relationships, and hidden knowledge.</p>
                </div>
                <div>
                    <h3 class="desc-h3">Real-time Reasoning</h3>
                    <p>Every few seconds, each agent perceives their environment and makes decisions based on their personality, goals, and memories. The story unfolds organically through their autonomous choices.</p>
                </div>
                <div>
                    <h3 class="desc-h3">Interactive Catalyst</h3>
                    <p>As the observer, you can introduce rumors, events, or environmental changes that serve as catalysts for new narrative directions, but you cannot directly control the agents.</p>
                </div>
            </div>
            <div class="desc-highlight">
                <p>
                    <strong>Vespera Under Armistice:</strong> The station balances a fragile ceasefire while Asterion pushes the siphon array online. Prefect Evelyn Hart weighs stability against corporate capture; Dock Chief Jonah Reyes defends ring autonomy; Dr. Priya Raman flags anomaly jitter near the Terraforming Yard; and foreman Declan Murphy races the schedule. Will the armistice hold as rumors and events ripple through the Agora, Nebula Cantina, and Command Spire?
                </p>
            </div>
        </div>
    </main>

    <!-- Subtle background effect -->
    <div class="bg-stripe" aria-hidden="true"></div>
</div>

@if (_showSummaryModal)
{
    <div class="modal-backdrop" @onclick="CloseSummaryModal">
        <div class="modal-card" @onclick:stopPropagation>
            <div class="modal-header">
                <div class="modal-title">World Summary</div>
                <button class="btn-close" @onclick="CloseSummaryModal">×</button>
            </div>
            <div class="modal-body">
                @if (_isSummarizing)
                {
                    <div class="loading">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Generating...</span>
                        </div>
                        <span>Generating summary...</span>
                    </div>
                }
                else
                {
                    <div class="markdown" style="max-height:50vh; overflow:auto;">
                        @((MarkupString)MarkdownAsHtml(_summary ?? string.Empty))
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseSummaryModal">Close</button>
                <button class="btn btn-primary" @onclick="GenerateSummary">Regenerate</button>
            </div>
        </div>
    </div>
}
