@using System.ComponentModel

<div class="aq-card aq-root">
    <div class="aq-card-header aq-flex aq-justify-between aq-align-center">
        <strong>Action Queue - Evidence-Linked Recommendations (gpt-oss-generated)</strong>
        <span class="aq-text-sm aq-text-muted">@Items.Count actions</span>
    </div>
    <div class="aq-list aq-list-flush">
        @if (Items.Count == 0)
        {
            <div class="aq-list-item"><span class="aq-text-muted">No actions yet.</span></div>
        }
        else
        {
            var idx = 0;
            foreach (var it in Items.OrderByDescending(x => x.UrgencyLevel))
            {
                idx++;
                <div class="aq-list-item">
                    <div class="aq-flex aq-justify-between aq-align-start">
                        <div>
                            <span class="aq-badge aq-badge-dark aq-me-2">#@idx</span>
                            <span class="aq-fw-semibold">@it.Title</span>
                            @if (UrgencyBadge(it) is { } badge)
                            {
                                <span class="aq-badge aq-badge-danger aq-ms-2">@badge</span>
                            }
                            <div class="aq-text-muted aq-text-sm" style="position:relative">
                                @it.Rationale
                                <button type="button"
                                        class="aq-toggle"
                                        aria-expanded="@IsExpanded(it)"
                                        @onclick="@(() => ToggleDetails(it))">
                                    <span>@(IsExpanded(it) ? "Collapse" : "Expand")</span>
                                    <span class="aq-chevron">
                                        @if (IsExpanded(it))
                                        {
                                            <span>▲</span>
                                        }
                                        else
                                        {
                                            <span>▼</span>
                                        }
                                    </span>
                                </button>
                            </div>

                            @* Floating toggle button to show/hide details *@
                            <div class="aq-details-container">

                                @if (IsExpanded(it))
                                {
                                    <div class="aq-details">
                                        <h5>Details</h5>
                                        <div style="padding:.8rem">@((MarkupString)MarkdownAsHtml(it.FullMarkdown))</div>
                                    </div>
                                }

                            </div>
                        </div>
                        <div>
                            <select class="aq-select aq-select-sm aq-status" @onchange="@((ChangeEventArgs e) => ChangeStatus(it, e))">
                                <option selected>Pending</option>
                                <option>In Progress</option>
                                <option>Completed</option>
                                <option>Deferred</option>
                            </select>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>