@using System.ComponentModel

<div class="card aq-root">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <strong>Action Queue - Evidence-Linked Recommendations</strong>
        <span class="small text-muted">@Items.Count actions</span>
    </div>
    <div class="list-group list-group-flush">
        @if (Items.Count == 0)
        {
            <div class="list-group-item"><span class="text-muted">No actions yet.</span></div>
        }
        else
        {
            var idx = 0;
            foreach (var it in Items)
            {
                idx++;
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="badge bg-dark me-2">#@idx</span>
                            <span class="fw-semibold">@it.Title</span>
                            @if (UrgencyBadge(it) is { } badge)
                            {
                                <span class="badge bg-danger ms-2">@badge</span>
                            }
                            <div class="text-muted small">@it.Rationale</div>

                            @* Floating toggle button to show/hide details *@
                            <div class="aq-details-container">
                                @if (IsExpanded(it))
                                {
                                    <div class="aq-details">
                                        <h5>Details</h5>
                                        <div style="padding:.8rem">@((MarkupString)MarkdownAsHtml(it.FullMarkdown))</div>
                                    </div>
                                }
                                <button type="button"
                                        class="aq-toggle"
                                        aria-expanded="@IsExpanded(it)"
                                        @onclick="@(() => ToggleDetails(it))">
                                    <span>@(IsExpanded(it) ? "Collapse" : "Expand")</span>
                                    <span class="aq-chevron">
                                        @if (IsExpanded(it))
                                        {
                                            <span>▲</span>
                                        }
                                        else
                                        {
                                            <span>▼</span>
                                        }
                                    </span>
                                </button>
                            </div>
                        </div>
                        <div>
                            <select class="form-select form-select-sm aq-status" @onchange="@((ChangeEventArgs e) => ChangeStatus(it, e))">
                                <option selected>Pending</option>
                                <option>In Progress</option>
                                <option>Completed</option>
                                <option>Deferred</option>
                            </select>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>